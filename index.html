<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Dashboard - Temperature & Humidity</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial; margin: 0; padding: 0; background: #f4f4f4; }
  header { text-align: center; padding: 0px; background: #222; color: #fff; font-size: 1.5em; }
  .container { display: flex; flex-wrap: wrap; padding: 10px; }
  .table-container { flex: 1; min-width: 300px; margin-right: 10px; background: #fff; padding: 10px; border-radius: 5px; max-height: 600px; overflow-y: auto; }
  .chart-container { flex: 2; min-width: 300px; background: #fff; padding: 10px; border-radius: 5px; }
  table { width: 100%; border-collapse: collapse; }
  table th, table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
  table th { background: #222; color: #fff; }
  .alerts { background: #fff; margin: 10px auto; padding: 10px; border-radius: 5px; max-width: 1000px; min-height: 60px; }
  .alert-item { color: red; font-weight: bold; }
</style>
</head>
<body>

<header><h3>ðŸŒ¡ Live Temperature & ðŸ’§ Humidity Dashboard</header>
<div id="deviceStatus" style="
  text-align:center;
  font-weight:bold;
  padding:6px;
  font-size:16px;">
Checking device status...
</div>

<div class="container">
  <div class="table-container">
    <h3>Latest Readings</h3>
    <table id="dataTable">
      <thead>
        <tr><th>Time</th><th>Temp (Â°C)</th><th>Humidity (%)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="chart-container">
    <canvas id="myChart"></canvas>
  </div>
</div>

<div class="alerts" id="alerts">
  <strong>Alerts & Logs:</strong>
  <div id="alertContent"></div>
</div>

<script>
const sheetURL = "https://opensheet.elk.sh/1Om7C4niF3p1A9dEc_8I7xWJtTlsbK0p-54gS5PKzEHM/Sheet1";
let myChart = null;

function loadData() {
  fetch(sheetURL)
    .then(res => res.json())
    .then(data => {

      // --- Update Table ---
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      const last10 = data.slice(-10); // last 10 readings
      last10.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row["Time Stamp"]}</td><td>${row["Temperature "]}</td><td>${row["Humidity "]}</td>`;
        tbody.appendChild(tr);
      });

      // --- Update Chart ---
      const labels = data.map(r => r["Time Stamp"]);
      const temp = data.map(r => Number(r["Temperature "]));
      const hum = data.map(r => Number(r["Humidity "]));
      const ctx = document.getElementById("myChart").getContext("2d");
      if(myChart) myChart.destroy();

      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: "Temperature (Â°C)", data: temp, borderColor: 'red', borderWidth: 2 },
            { label: "Humidity (%)", data: hum, borderColor: 'blue', borderWidth: 2 }
          ]
        },
        options: { responsive: true, animation: false }
      });

      // --- Alerts & Logs ---
      const alertDiv = document.getElementById("alertContent");
      alertDiv.innerHTML = "";
      last10.forEach(r => {
        if(Number(r["Temperature "]) > 30) {
          const div = document.createElement("div");
          div.className = "alert-item";
          div.textContent = `High Temp Alert! ${r["Temperature "]}Â°C at ${r["Time Stamp"]}`;
          alertDiv.appendChild(div);
        }
        if(Number(r["Humidity "]) < 35) {
          const div = document.createElement("div");
          div.className = "alert-item";
          div.textContent = `Low Humidity Alert! ${r["Humidity "]}% at ${r["Time Stamp"]}`;
          alertDiv.appendChild(div);
        }
      });

    }).catch(err => console.error("Error fetching data:", err));
}

// First load
loadData();
// Auto-refresh every 10 seconds
setInterval(loadData, 10000);

// ðŸŸ¢ DEVICE ONLINE / OFFLINE CHECK
const last = data[data.length - 1];
const lastTime = new Date(last["Time Stamp"]);
const now = new Date();
const diffSeconds = (now - lastTime) / 1000;

const statusDiv = document.getElementById("deviceStatus");

if (diffSeconds <= 30) {
  statusDiv.innerHTML = "ðŸŸ¢ ESP8266 ONLINE";
  statusDiv.style.color = "green";
} else {
  statusDiv.innerHTML = "ðŸ”´ ESP8266 OFFLINE (No data)";
  statusDiv.style.color = "red";
}


</script>

<center><h1>Develop By Musab Jan and Team </h1></center>

</body>
</html>
